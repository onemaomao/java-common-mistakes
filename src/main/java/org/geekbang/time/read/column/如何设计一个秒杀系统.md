开篇词 | 秒杀系统架构设计都有哪些关键点？
秒杀其实主要解决两个问题，一个是并发读，一个是并发写。
秒杀的整体架构可以概括为“稳、准、快”几个关键字。高性能, 一致性, 高可用

01 | 设计秒杀系统时应该注意的5个架构原则
架构原则：“4 要 1 不要”
    1.数据要尽量少
        压缩和转码消耗CPU,序列化和发序列化消耗CPU
    2.请求数要尽量少
        额外请求,三次握手,页面依赖,连接限制,串行加载,DNS解析
        合并CSS,JS等
    3.路径要尽量短
        每经过结点会新增连接,每增加一个连接都会新增不确定性
    4.依赖要尽量少
        强依赖
        弱依赖紧急情况下可以去掉
        系统分级
    5.不要有单点
        把服务无状态化
不同场景下的不同架构案例
演进过程
一、1w/s 到了 10w/s 的量级(文稿演进之后的架构图)
    秒杀系统独立,针对性优化
    系统部署集群独立,不影响正常集群业务
    热点数据单独缓存
    答题防秒杀器抢单
二、超过 100w/s 量级(文稿演进之后的架构图)
    对页面的动静分离
    在服务端对秒杀商品进行本地缓存
    增加系统限流保护

02 | 如何才能做好动静分离？有哪些方案可选？
何为动静数据
    “动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和 URL、浏览者、时间、地域相关，以及是否含有 Cookie 等私密数据。
    第一，你应该把静态数据缓存到离用户最近的地方。
        浏览器里、CDN 上或者在服务端的 Cache 中?
    第二，静态化改造就是要直接缓存 HTTP 连接。
    第三，让谁来缓存静态数据也很重要。
如何做动静分离的改造
从 5 个方面来分离出动态内容
    URL 唯一化。
        商品详情系统天然地就可以做到 URL 唯一化
        缓存整个 HTTP 连接,URL 作为缓存的 Key
    分离浏览者相关的因素。
        登录，以及登录身份单独拆分通过动态请求来获取
    分离时间因素。
        服务端输出的时间也通过动态请求获取
    异步化地域因素。
    去掉 Cookie。
    动态内容的处理通常有两种方案:ESI 方案（或者 SSI）,CSI 方案
动静分离的几种架构方案的结构图以及各种方案的优缺点
    方案 1：实体机单机部署
    方案 2：统一 Cache 层
    方案 3：上 CDN
        失效问题,命中率问题,发布更新问题
        选择若干个节点实施满足的几个条件
            靠近访问量比较集中的地区；
            离主站相对较远；
            节点到主站间的网络比较好，而且稳定；
            节点容量比较大，不会占用其他 CDN 太多的资源。
            节点不要太多
        选择 CDN 的二级 Cache
        CDN 化部署方案的特点
            把整个页面缓存在用户浏览器中；
            如果强制刷新整个页面，也会请求 CDN；
            实际有效请求，只是用户对“刷新抢宝”按钮的点击。

03 | 二八原则：有针对性地处理好系统的“热点数据”
为什么要关注热点
    热点请求会大量占用服务器处理资源
    识别热点用更低的代价来支撑
什么是“热点”
    热点分为热点操作和热点数据
        “静态热点数据”，能够提前预测的热点数据。
        “动态热点数据”，不能被提前预测到的，系统在运行过程中临时产生的热点。
发现静态热点数据
    商业手段:卖家报名参加
    提前预测:历史TOP N
发现动态热点数据
    打造热点发现系统
处理热点数据
    处理热点数据通常有几种思路：一是优化，二是限制，三是隔离。
    业务隔离,系统隔离,数据隔离

04 | 流量削峰这事应该怎么做？
为什么要削峰
排队
    消息队列,线程池加锁等待,先进先出、先进后出等常用的内存排队,请求序列化到文件中，然后再顺序地读文件恢复请求
    共同特征，就是把“一步的操作”变成“两步的操作”，其中增加的一步操作用来起到缓冲的作用
答题
    防止秒杀器,延缓请求
分层过滤
    CDN->前台系统->后台系统->DB 漏斗状
    分层过滤的核心思想是：在不同的层次尽可能地过滤掉无效请求，让“漏斗”最末端的才是有效请求。
    要达到这种效果，我们就必须对数据做分层的校验。
    分层校验的基本原则是

05 | 影响性能的因素有哪些？又该如何提高系统的性能？
影响性能的因素
    首先，我们先来看看响应时间和 QPS 有啥关系。
        真正对性能有影响的是 CPU 的执行时间。这也很好理解，因为 CPU 的执行真正消耗了服务器的资源。经过实际的测试，如果减少 CPU 一半的执行时间，就可以增加一倍的 QPS。
        也就是说，我们应该致力于减少 CPU 的执行时间。
    其次，我们再来看看线程数对 QPS 的影响。
        很多多线程的场景都有一个默认配置，即“线程数 = 2 * CPU 核数 + 1”
        线程数 = [(线程等待时间 + 线程 CPU 时间) / 线程 CPU 时间] × CPU 数量
        当然，最好的办法是通过性能测试来发现最佳的线程数。
如何发现瓶颈
    常用工具
如何优化系统
    1. 减少编码
    2. 减少序列化
    3. Java 极致优化
    4. 并发读优化

06 | 秒杀系统“减库存”设计的核心逻辑
减库存有哪几种方式
    下单减库存-有些人下完单可能并不会付款
    付款减库存-可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了
    预扣库存-买家下单后，库存为其保留一定的时间（如 10 分钟），超过这个时间，库存将会自动释放
减库存可能存在的问题
    下单减库存-恶意下单影响卖家的商品销售
    付款减库存-库存超卖
    两者相结合(预扣库存)-有效的付款时间设置为 10 分钟，但是恶意买家完全可以在 10 分钟后再次下单
        结合安全和反作弊的措施来制止
大型秒杀中如何减库存？
    最常见的预扣库存方案
    一致性的处理:事务中处理中判断库存不为负数;数据库的字段数据为无符号整数;CASE WHEN 判断语句
秒杀减库存的极致优化
    如何在缓存中减库存以及如何在数据库中减库存
    缓存减库存
        如果你的秒杀商品的减库存逻辑非常单一，比如没有复杂的 SKU 库存和总库存这种联动关系的话，觉得完全可以使用缓存。
        但是如果有比较复杂的减库存逻辑，或者需要使用事务，你还是必须在数据库中完成减库存。
    数据库减库存
        解决并发锁的问题:应用层做排队,数据库层做排队

07 | 准备Plan B：如何设计兜底方案?
高可用建设应该从哪里着手
    系统的高可用建设涉及架构阶段、编码阶段、测试阶段、发布阶段、运行阶段，以及故障发生时
    为什么系统的高可用建设要放到整个生命周期中全面考虑？因为我们在每个环节中都可能犯错，而有些环节犯的错，你在后面是无法弥补的。
降级
限流
    客户端限流,服务端限流
拒绝服务

08 | 答疑解惑：缓存失效的策略应该怎么定？























